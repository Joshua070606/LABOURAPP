<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Shabari Constructions - Site & Laborer Tracker</title>
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; max-width: 1200px; margin: 20px auto; padding: 20px; background: #f0f4f8; color: #333; }
    h1 { text-align: center; color: #2c3e50; margin-bottom: 5px; }
    .company-subtitle { text-align: center; font-size: 1.2em; color: #7f8c8d; margin-bottom: 30px; }
    h2 { color: #34495e; border-bottom: 2px solid #3498db; padding-bottom: 8px; }
    nav { text-align: center; margin: 30px 0; }
    nav a { margin: 0 10px; padding: 12px 20px; background: #3498db; color: white; text-decoration: none; border-radius: 6px; font-weight: bold; }
    nav a:hover { background: #2980b9; }
    section { background: white; padding: 25px; margin: 20px 0; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    label { display: block; margin: 12px 0 6px; font-weight: bold; color: #2c3e50; }
    input, select, textarea { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #bdc3c7; border-radius: 6px; font-size: 16px; }
    textarea { height: 100px; resize: vertical; }
    button { background: #27ae60; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; margin: 5px; }
    button:hover { background: #219a52; }
    .btn-danger { background: #e74c3c; }
    .btn-danger:hover { background: #c0392b; }
    .btn-secondary { background: #95a5a6; }
    .btn-secondary:hover { background: #7f8c8d; }
    .btn-markall { background: #9b59b6; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
    th { background: #3498db; color: white; cursor: pointer; }
    th:hover { background: #2980b9; }
    tr:nth-child(even) { background: #f9f9f9; }
    .clickable { color: #0066cc; cursor: pointer; text-decoration: underline; }
    .search-box { margin-bottom: 20px; }
    .hidden { display: none; }
    .monthly-summary { background: #ecf0f1; padding: 20px; border-radius: 8px; margin: 20px 0; }
    .total-row { font-weight: bold; background: #d5dbdb !important; font-size: 1.1em; }
    .site-card { background: #f8f9fa; padding: 15px; margin: 15px 0; border-left: 5px solid #3498db; border-radius: 6px; }
    .present-count { font-size: 1.3em; font-weight: bold; color: #27ae60; margin: 20px 0; }
    @media print {
      nav, button:not(.print-btn), .no-print { display: none !important; }
      body { background: white; }
      section { box-shadow: none; }
    }
  </style>
</head>
<body>

  <h1>üõ†Ô∏è Shabari Constructions</h1>
  <p class="company-subtitle">Site, Laborer & Daily Progress Tracker</p>

  <nav>
    <a onclick="showSection('home')">Home</a>
    <a onclick="showSection('sites')">Sites</a>
    <a onclick="showSection('add-site')">Add Site</a>
    <a onclick="showSection('add-laborer')">Add Laborer</a>
    <a onclick="showSection('attendance')">Daily Attendance</a>
    <a onclick="showSection('dashboard')">Laborers</a>
    <a onclick="showSection('reports')">Reports</a>
    <a onclick="showSection('backup')">Backup</a>
  </nav>

  <!-- Home -->
  <section id="home">
    <h2>Welcome to Shabari Constructions Tracker</h2>
    <p>Manage multiple construction sites, assign laborers, track daily attendance, work progress, materials, wages, advances, and generate reports.</p>
    <p>All data saved automatically in your browser.</p>
  </section>

  <!-- Sites List -->
  <section id="sites" class="hidden">
    <h2>All Sites</h2>
    <div id="sitesList"></div>
  </section>

  <!-- Add Site -->
  <section id="add-site" class="hidden">
    <h2>Add New Site/Project</h2>
    <label>Site Name</label>
    <input type="text" id="newSiteName" placeholder="e.g. ABC Apartments, Phase 2" />
    <label>Location (Optional)</label>
    <input type="text" id="newSiteLocation" />
    <button onclick="addSite()">Add Site</button>
    <p id="siteMsg"></p>
  </section>

  <!-- Add Laborer -->
  <section id="add-laborer" class="hidden">
    <h2>Add New Laborer</h2>
    <label>Name</label>
    <input type="text" id="newName" required />
    <label>Contact</label>
    <input type="text" id="newContact" />
    <label>Assigned Site</label>
    <select id="newSiteId"></select>
    <label>Daily Wage (‚Çπ)</label>
    <input type="number" id="newWage" step="0.01" required />
    <button onclick="addLaborer()">Add Laborer</button>
    <p id="addMsg"></p>
  </section>

  <!-- Daily Attendance & Site Log -->
  <section id="attendance" class="hidden">
    <h2>Daily Attendance & Site Log</h2>
    <label>Date</label>
    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
      <input type="date" id="attendDate" />
      <button onclick="setToday()">Today</button>
      <button onclick="setYesterday()">Yesterday</button>
      <button onclick="setTomorrow()">Tomorrow</button>
    </div>
    <button onclick="loadAttendanceForm()">Load Day</button>

    <div style="margin:20px 0;">
      <button class="btn-markall" onclick="markAll('Full Day')">Mark All Full Day</button>
      <button class="btn-markall" onclick="markAll('Half Day')">Mark All Half Day</button>
      <button class="btn-markall" onclick="markAll('Absent')">Mark All Absent</button>
    </div>

    <div id="attendanceForm"></div>
    <div id="presentCount" class="present-count"></div>
    <div id="dailyTotal" style="font-size:1.2em;font-weight:bold;"></div>

    <h3 style="margin-top:40px;">Daily Site Progress & Materials Log</h3>
    <div id="siteLogForm"></div>
  </section>

  <!-- Laborers Dashboard -->
  <section id="dashboard" class="hidden">
    <h2>Laborers Dashboard</h2>
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="Search by name..." onkeyup="filterLaborers()" />
    </div>
    <button onclick="exportFullCSV()">üìÑ Export All Data (CSV)</button>
    <div id="laborerList"></div>
  </section>

  <!-- Monthly Reports -->
  <section id="reports" class="hidden">
    <h2>Monthly Wage Report</h2>
    <label>Select Month</label>
    <input type="month" id="reportMonth" />
    <button onclick="generateMonthlyReport()">Generate Report</button>
    <button class="print-btn" onclick="window.print()">üñ®Ô∏è Print</button>
    <button onclick="exportMonthlyCSV()">üìÑ Export CSV</button>
    <div id="monthlyReport" class="monthly-summary hidden"></div>
  </section>

  <!-- Backup -->
  <section id="backup" class="hidden">
    <h2>Backup & Restore</h2>
    <button onclick="exportJSON()">Export Full Backup (JSON)</button>
    <button onclick="document.getElementById('importFile').click()">Import Backup</button>
    <input type="file" id="importFile" accept=".json" style="display:none;" onchange="importJSON(event)" />
  </section>

  <!-- Individual Laborer View (hidden, populated dynamically) -->
  <section id="laborer-detail" class="hidden">
    <h2>Laborer Details</h2>
    <button onclick="showSection('dashboard')">‚Üê Back to Dashboard</button>
    <div id="detailContent"></div>
  </section>

  <script>
    // ====== DATA ======
    let sites = JSON.parse(localStorage.getItem('sites')) || [];
    let laborers = JSON.parse(localStorage.getItem('laborers')) || [];
    let attendance = JSON.parse(localStorage.getItem('attendance')) || {}; // {date: [{id, status}]}
    let siteLogs = JSON.parse(localStorage.getItem('siteLogs')) || {}; // {date: {siteId: {progress, materials}}}
    let finances = JSON.parse(localStorage.getItem('finances')) || {}; // {laborerId: {advances: [], deductions: [], paidMonths: []}}

    function saveData() {
      localStorage.setItem('sites', JSON.stringify(sites));
      localStorage.setItem('laborers', JSON.stringify(laborers));
      localStorage.setItem('attendance', JSON.stringify(attendance));
      localStorage.setItem('siteLogs', JSON.stringify(siteLogs));
      localStorage.setItem('finances', JSON.stringify(finances));
    }

    function showSection(id) {
      document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
      if (id === 'dashboard') renderLaborersDashboard();
      if (id === 'sites') renderSitesList();
      if (id === 'add-laborer') populateSiteDropdown();
      if (id === 'attendance') setToday();
      if (id === 'reports') {
        const now = new Date();
        document.getElementById('reportMonth').value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
      }
    }

    // ====== SITES ======
    function addSite() {
      const name = document.getElementById('newSiteName').value.trim();
      const location = document.getElementById('newSiteLocation').value.trim();
      if (!name) return alert("Site name required");
      const id = Date.now();
      sites.push({id, name, location});
      saveData();
      document.getElementById('newSiteName').value = '';
      document.getElementById('newSiteLocation').value = '';
      alert("Site added!");
      renderSitesList();
    }

    function renderSitesList() {
      const div = document.getElementById('sitesList');
      let html = `<h3>Active Sites (${sites.length})</h3>`;
      sites.forEach(site => {
        const workers = laborers.filter(l => l.siteId === site.id);
        html += `<div class="site-card">
          <strong>${site.name}</strong> ${site.location ? '(' + site.location + ')' : ''}
          <p><strong>Laborers assigned:</strong> ${workers.length} 
             (${workers.map(w => w.name).join(', ') || 'None'})</p>
        </div>`;
      });
      div.innerHTML = html;
    }

    function populateSiteDropdown() {
      const select = document.getElementById('newSiteId');
      select.innerHTML = sites.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
      if (sites.length === 0) select.innerHTML = '<option>No sites yet</option>';
    }

    // ====== LABORERS ======
    function addLaborer() {
      const name = document.getElementById('newName').value.trim();
      const contact = document.getElementById('newContact').value.trim();
      const siteId = parseInt(document.getElementById('newSiteId').value);
      const wage = parseFloat(document.getElementById('newWage').value);
      if (!name || isNaN(wage) || isNaN(siteId)) return alert("Fill all fields correctly");
      const id = Date.now();
      laborers.push({id, name, contact, siteId, wage});
      finances[id] = {advances: [], deductions: [], paidMonths: []};
      saveData();
      document.getElementById('newName').value = ''; document.getElementById('newContact').value = ''; document.getElementById('newWage').value = '';
      alert("Laborer added!");
    }

    function showLaborerDetail(id) {
      const l = laborers.find(x => x.id === id);
      const site = sites.find(s => s.siteId === l.siteId);
      let html = `<h3>${l.name} - ${site ? site.name : 'No site'}</h3>
        <p><strong>Contact:</strong> ${l.contact || '-'}</p>
        <p><strong>Daily Wage:</strong> ‚Çπ${l.wage}</p>`;

      // Attendance history
      html += `<h4>Attendance History</h4><table><tr><th>Date</th><th>Status</th><th>Earned</th></tr>`;
      Object.keys(attendance).sort().reverse().forEach(date => {
        const rec = attendance[date].find(a => a.id === id);
        if (rec) {
          const earned = rec.status === 'Full Day' ? l.wage : (rec.status === 'Half Day' ? l.wage/2 : 0);
          html += `<tr><td>${date}</td><td>${rec.status}</td><td>‚Çπ${earned}</td></tr>`;
        }
      });
      html += `</table>`;

      // Finances
      const fin = finances[id];
      html += `<h4>Advances & Deductions</h4><table><tr><th>Type</th><th>Date</th><th>Amount</th><th>Reason</th></tr>`;
      fin.advances.forEach(a => html += `<tr><td>Advance</td><td>${a.date}</td><td>‚Çπ${a.amount}</td><td>${a.reason || '-'}</td></tr>`);
      fin.deductions.forEach(d => html += `<tr><td>Deduction</td><td>${d.date}</td><td>‚Çπ${d.amount}</td><td>${d.reason || '-'}</td></tr>`);
      html += `</table>`;

      document.getElementById('detailContent').innerHTML = html;
      showSection('laborer-detail');
    }

    // ====== ATTENDANCE & SITE LOG ======
    function setToday() { document.getElementById('attendDate').value = '2026-01-02'; loadAttendanceForm(); } // as per current date
    function setYesterday() { document.getElementById('attendDate').value = '2026-01-01'; loadAttendanceForm(); }
    function setTomorrow() { document.getElementById('attendDate').value = '2026-01-03'; loadAttendanceForm(); }

    function markAll(status) {
      const date = document.getElementById('attendDate').value;
      if (!date) return alert("Select date");
      if (!attendance[date]) attendance[date] = [];
      laborers.forEach(l => {
        const existing = attendance[date].find(a => a.id === l.id);
        if (existing) existing.status = status;
        else attendance[date].push({id: l.id, status});
      });
      saveData();
      loadAttendanceForm();
    }

    function loadAttendanceForm() {
      const date = document.getElementById('attendDate').value;
      if (!date) return;

      // Attendance table grouped by site
      let html = `<h3>Attendance - ${date}</h3>`;
      const sitesMap = {};
      laborers.forEach(l => {
        const site = sites.find(s => s.id === l.siteId) || {name: "Unassigned", id: 0};
        if (!sitesMap[site.id]) sitesMap[site.id] = {site, laborers: []};
        sitesMap[site.id].laborers.push(l);
      });

      let fullCount = 0, halfCount = 0, dailyTotal = 0;

      Object.keys(sitesMap).forEach(siteId => {
        const {site, laborers: siteLabs} = sitesMap[siteId];
        if (siteId == 0 && siteLabs.length === 0) return;
        html += `<h4>${site.name} (${siteLabs.length} laborers)</h4><table><tr><th>Name</th><th>Status</th><th>Actions</th></tr>`;
        siteLabs.forEach(l => {
          const rec = (attendance[date] || []).find(a => a.id === l.id) || {status: 'Absent'};
          const earned = rec.status === 'Full Day' ? l.wage : (rec.status === 'Half Day' ? l.wage/2 : 0);
          dailyTotal += earned;
          if (rec.status === 'Full Day') fullCount++;
          if (rec.status === 'Half Day') halfCount++;

          html += `<tr>
            <td>${l.name}</td>
            <td>
              <select onchange="updateAttendance('${date}', ${l.id}, this.value)">
                <option value="Full Day" ${rec.status==='Full Day'?'selected':''}>Full Day</option>
                <option value="Half Day" ${rec.status==='Half Day'?'selected':''}>Half Day</option>
                <option value="Absent" ${rec.status==='Absent'?'selected':''}>Absent</option>
              </select>
            </td>
            <td>
              <button class="btn-secondary" onclick="addAdvance(${l.id}, '${date}')">+Advance</button>
              <button class="btn-danger" onclick="addDeduction(${l.id}, '${date}')">-Deduct</button>
            </td>
          </tr>`;
        });
        html += `</table>`;
      });

      document.getElementById('attendanceForm').innerHTML = html;
      document.getElementById('presentCount').textContent = `Present: ${fullCount} Full + ${halfCount} Half = ${fullCount + halfCount} workers`;
      document.getElementById('dailyTotal').textContent = `Total wages for ${date}: ‚Çπ${dailyTotal.toFixed(2)}`;

      // Site Log Form
      let logHtml = `<h4>Daily Progress & Materials Log for ${date}</h4>`;
      sites.forEach(site => {
        const log = (siteLogs[date] && siteLogs[date][site.id]) || {progress: '', materials: ''};
        logHtml += `<div class="site-card">
          <strong>${site.name}</strong>
          <label>Work Progress Today</label>
          <textarea id="progress_${site.id}">${log.progress}</textarea>
          <label>Materials Update (Received/Used/Remaining)</label>
          <textarea id="materials_${site.id}">${log.materials}</textarea>
          <button onclick="saveSiteLog('${date}', ${site.id})">Save Log for ${site.name}</button>
        </div>`;
      });
      document.getElementById('siteLogForm').innerHTML = logHtml;
    }

    function updateAttendance(date, id, status) {
      if (!attendance[date]) attendance[date] = [];
      const rec = attendance[date].find(a => a.id === id);
      if (rec) rec.status = status;
      else attendance[date].push({id, status});
      saveData();
      loadAttendanceForm();
    }

    function saveSiteLog(date, siteId) {
      const progress = document.getElementById(`progress_${siteId}`).value;
      const materials = document.getElementById(`materials_${siteId}`).value;
      if (!siteLogs[date]) siteLogs[date] = {};
      siteLogs[date][siteId] = {progress, materials};
      saveData();
      alert("Site log saved!");
    }

    function addAdvance(id, date) {
      const amount = prompt("Advance amount:");
      const reason = prompt("Reason (optional):");
      if (amount && !isNaN(amount) && amount > 0) {
        finances[id].advances.push({date, amount: parseFloat(amount), reason});
        saveData();
        alert("Advance recorded");
      }
    }

    function addDeduction(id, date) {
      const amount = prompt("Deduction amount:");
      const reason = prompt("Reason (optional):");
      if (amount && !isNaN(amount) && amount > 0) {
        finances[id].deductions.push({date, amount: parseFloat(amount), reason});
        saveData();
        alert("Deduction recorded");
      }
    }

    // ====== DASHBOARD ======
    function renderLaborersDashboard() {
      const div = document.getElementById('laborerList');
      let html = `<table id="laborerTable">
        <tr><th onclick="sortTable(0)">Name</th><th>Site</th><th>Wage</th><th>Total Earned</th><th>Advances</th><th>Deductions</th><th>Net Payable</th></tr>`;
      laborers.forEach(l => {
        const site = sites.find(s => s.id === l.siteId);
        let earned = 0;
        Object.keys(attendance).forEach(d => {
          const rec = attendance[d].find(a => a.id === l.id);
          if (rec) earned += rec.status === 'Full Day' ? l.wage : (rec.status === 'Half Day' ? l.wage/2 : 0);
        });
        const fin = finances[l.id];
        const adv = fin.advances.reduce((s,a)=>s+a.amount,0);
        const ded = fin.deductions.reduce((s,d)=>s+d.amount,0);
        const net = earned - adv - ded;
        html += `<tr>
          <td class="clickable" onclick="showLaborerDetail(${l.id})">${l.name}</td>
          <td>${site ? site.name : '-'}</td>
          <td>‚Çπ${l.wage}</td>
          <td>‚Çπ${earned.toFixed(2)}</td>
          <td>‚Çπ${adv.toFixed(2)}</td>
          <td>‚Çπ${ded.toFixed(2)}</td>
          <td>‚Çπ${net.toFixed(2)}</td>
        </tr>`;
      });
      html += `</table>`;
      div.innerHTML = html;
    }

    function filterLaborers() {
      const input = document.getElementById('searchInput').value.toLowerCase();
      document.querySelectorAll('#laborerTable tr').forEach((row, i) => {
        if (i === 0) return;
        const name = row.cells[0].textContent.toLowerCase();
        row.style.display = name.includes(input) ? '' : 'none';
      });
    }

    // ====== REPORTS ======
    function generateMonthlyReport() {
      const month = document.getElementById('reportMonth').value;
      if (!month) return alert("Select month");
      const [year, mon] = month.split('-');
      const reportDiv = document.getElementById('monthlyReport');
      reportDiv.classList.remove('hidden');

      let html = `<h3>Shabari Constructions - Monthly Wage Report (${new Date(year, mon-1).toLocaleString('default', {month:'long', year:'numeric'})})</h3>
        <table><tr><th>Laborer</th><th>Site</th><th>Full</th><th>Half</th><th>Earned</th><th>Advances</th><th>Deductions</th><th>Net</th><th>Paid?</th></tr>`;

      let grandTotal = 0;
      laborers.forEach(l => {
        let full = 0, half = 0, earned = 0;
        for (let d=1; d<=31; d++) {
          const date = `${year}-${mon}-${String(d).padStart(2,'0')}`;
          if (!attendance[date]) continue;
          const rec = attendance[date].find(a => a.id === l.id);
          if (rec && rec.status === 'Full Day') { full++; earned += l.wage; }
          else if (rec && rec.status === 'Half Day') { half++; earned += l.wage/2; }
        }
        const fin = finances[l.id];
        const adv = fin.advances.filter(a => a.date.startsWith(month)).reduce((s,a)=>s+a.amount,0);
        const ded = fin.deductions.filter(d => d.date.startsWith(month)).reduce((s,d)=>s+d.amount,0);
        const net = earned - adv - ded;
        grandTotal += net;

        const paid = fin.paidMonths.includes(month);
        html += `<tr>
          <td>${l.name}</td>
          <td>${sites.find(s=>s.id===l.siteId)?.name || '-'}</td>
          <td>${full}</td><td>${half}</td>
          <td>‚Çπ${earned.toFixed(2)}</td>
          <td>‚Çπ${adv.toFixed(2)}</td>
          <td>‚Çπ${ded.toFixed(2)}</td>
          <td>‚Çπ${net.toFixed(2)}</td>
          <td><input type="checkbox" ${paid?'checked':''} onchange="togglePaid(${l.id}, '${month}', this.checked)"> ${paid?'Paid':''}</td>
        </tr>`;
      });
      html += `<tr class="total-row"><td colspan="8">TOTAL PAYABLE</td><td>‚Çπ${grandTotal.toFixed(2)}</td></tr></table>`;
      reportDiv.innerHTML = html;
    }

    function togglePaid(laborerId, month, checked) {
      const fin = finances[laborerId];
      if (checked && !fin.paidMonths.includes(month)) fin.paidMonths.push(month);
      else if (!checked) fin.paidMonths = fin.paidMonths.filter(m => m !== month);
      saveData();
    }

    // ====== EXPORT ======
    function exportFullCSV() {
      let csv = "Name,Site,Contact,Daily Wage,Total Earned,Advances,Deductions,Net Payable\n";
      laborers.forEach(l => {
        const site = sites.find(s => s.id === l.siteId);
        let earned = 0;
        Object.keys(attendance).forEach(d => {
          const rec = attendance[d].find(a => a.id === l.id);
          if (rec) earned += rec.status === 'Full Day' ? l.wage : (rec.status === 'Half Day' ? l.wage/2 : 0);
        });
        const fin = finances[l.id];
        const adv = fin.advances.reduce((s,a)=>s+a.amount,0);
        const ded = fin.deductions.reduce((s,d)=>s+d.amount,0);
        csv += `"${l.name}","${site?site.name:''}","${l.contact||''}",${l.wage},${earned},${adv},${ded},${(earned-adv-ded)}\n`;
      });
      downloadCSV(csv, "shabari_full_data.csv");
    }

    function exportMonthlyCSV() {
      // Similar to previous
      alert("Use browser print ‚Üí Save as PDF, or copy table for Excel");
    }

    function downloadCSV(content, filename) {
      const blob = new Blob([content], {type: 'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.click();
    }

    function exportJSON() {
      const data = {sites, laborers, attendance, siteLogs, finances};
      const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'shabari_full_backup.json'; a.click();
    }

    function importJSON(e) {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = ev => {
        try {
          const data = JSON.parse(ev.target.result);
          sites = data.sites || [];
          laborers = data.laborers || [];
          attendance = data.attendance || {};
          siteLogs = data.siteLogs || {};
          finances = data.finances || {};
          saveData();
          alert("Backup imported!");
          renderSitesList();
          renderLaborersDashboard();
        } catch { alert("Invalid file"); }
      };
      reader.readAsText(file);
    }

    // Initial
    setToday();
    renderSitesList();
    renderLaborersDashboard();
    showSection('home');
  </script>
</body>
</html>